# OS install guide

A complete overhauling documentation for OS reinstall, both Linux and Windows, from re-partitioning to setting up software.

## Useful tips

1. You can label disks and address them by `/dev/disk/by-label/mylabel` instead of `/dev/nvmeXxX`:

- `btrfs filesystem label /dev/disk label`
- `fatlabel /dev/disk LABEL` (fat32 requires uppercase)
- `cryptsetup config /dev/disk --label label`
- `e2label /dev/mapper/disk label`

## UEFI UPDATE

> Generate UKI if not generated yet
> `bootctl install` if used grub, before rebooting, for easy EFI enrollment

- Reboot, enroll bootloader and linux EFIs, load to linux with Secure Boot on.

(after Secure Boot is on, and system is loaded)
- pacman -S fwupd
- fwupdmgr refresh
- fwupdmgr get-updates
- fwupdmgr update

Backup current keys (or export via bios):

- pacman -S efitools
- `mkdir sb && for var in PK KEK db dbx; do efi-readvar -v $var -o sb/${var}.esl; done`

Reboot, set secure boot into Setup mode

Install & enroll sbctl + old keys.

> Consider copying existing keys from other machines, so that Arch Live CD is working seamlessly on all machines (store them on the same usb luks2 protected volume).

- pacman -S sbctl
- sbctl create-keys # to create new keys

Merge db:

- cert-to-efi-sig-list /var/lib/sbctl/keys/db/db.pem mydb.esl
- cat db.esl mydb.esl > merged_db.esl

Reboot, Turn secure boot into SETUP mode:

- efi-updatevar -e -k /var/lib/sbctl/keys/KEK/KEK.key -f sb/old_dbx.esl dbx
- efi-updatevar -e -k /var/lib/sbctl/keys/KEK/KEK.key -f merged_db.esl db
- chattr -i /sys/firmware/efi/efivars/db-*
- sbctl enroll-keys --partial PK KEK -fm

Reboot, check that it's User mode. Boot to system, regenerate PKI for testing :)

## Partitioning

My main PC has 3 drives: main, secondary, data.

### Laptop

For laptop it's rather simple, 2 drives:

- /main/1 - EFI, 1G
- /main/2 - Linux root, 200G, / (encrypted)
- /main/3 - Linux data, 500G, /mnt/data (encrypted)
- /main/4-5-6 - Microsoft System (reserved, system, recovery), 500G, system for Work+Gaming, encrypted
- /main/7(or 6 if windows did not reserve) - 100G, Windows Projects/Work files (encrypted)

- /secondary/1 - Linux backup, 200G, /mnt/backup (encrypted)
- /secondary/2 - Media/Data/Games, 400-500G, shared, NTFS, NOT encrypted

### main

- /main/1 - EFI, 1G
- /main/2 - Linux root, 200G, / (encrypted)
- /main/3 - Linux data, 500G, /mnt/data (encrypted)
- /main/4-5-6 - Microsoft System (reserved, system, recovery), 500G, system for gaming (encrypted)

### secondary

- /secondary/1-2-3 - Microsoft System (reserved, system, recovery), 400G, system for work (encrypted)
- /secondary/4 - Windows Data (projects) for pet projects, NTFS, 100G (encrypted)
- /secondary/5 - NTFS, Gaming (NOT encrypted)

### data

- /data/1 - Linux backup, 500G, /mnt/backup (encrypted)
- /data/2 - Linux NDA, 100G, encrypted (for sensitive project files)
- /data/3 - Windows NDA, 100G, encrypted (for sensitive project files)
- /data/4 - Shared NTFS Media/Games volume, 2T

## Bootloader

> EFI/BOOT folder can be removed - this is extra fallback option generated by systemd-boot.

- `Linux/arch-linux.efi` - Arch Linux
- `GamingMicrosoft` - Gaming Windows
- `WorkMicrosoft` - Work Windows

> Both Windows were installed in a row, to the same EFI, and then EFI folder was copied and extra entries deleted from Windows so we can load specific Windows.

## Creating partitions

```
fdisk /dev/1
g # Create new GPT partition table, generates UUID.
```

> By default uses 512b blocks, internally might be using 4k, and modern HDDs use 4k, but not worth it for SSD.

### Creating EFI partition

- EFI - 1Gb, FAT32, t1
- `mkfs.fat -F32 # dosfstools package`

### Creating linux encrypted partition

```
/dev/2
n, +200G # leave type default - Linux Filesystem
cryptsetup luksFormat /dev/2
# use secure password for PC (less secure) and EMPTY password for laptop (max security, only recovery key will work)
systemd-cryptenroll /dev/2 --recovery-key # save this securely
# Guide says using pcrs=7+15:sha0000 but that's the same as omitting 15, and without sha0000 it breaks boot
systemd-cryptenroll /dev/2 --wipe-slot=empty --tpm2-device=auto --tpm2-pcrs=7 # --tpm2-with-pin=yes
cryptsetup open /dev/2 root
mkfs.btrfs /dev/mapper/root
mount /dev/mapper/root /mnt # When needed for the installation
# Or:
cryptsetup close root
```

### Creating NTFS shared partition

- `mkfs.ntfs -f -L media drive` - fast format, label media

### Creating system partition for windows

Just leave empty unallocated space of fixed size before the next partition, and use it when installing Windows. It will create all necessary partitions.

## Mounting

- `/dev/2` as `/dev/mapper/root` as `/` - root
- `/dev/3` as `/dev/mapper/data` as `/mnt/data` - data
- `/dev/1` as `/efi` - EFI, as ROOT READONLY
  - `mount -o umask=0077,uid=0,gid=0` or include to fstab `umask=0077,uid=0,gid=0` instead of `fmask/dmask`
- `/dev/data/1` as `/dev/mapper/backup` as `/mnt/backup` - Backup drive from the 990 (other) drive, also encrypted
- `/dev/data/2` as `/dev/mapper/nda` as `/mnt/nda` - work partition, NOT auto-mounted
- `/dev/data/4` as `/mnt/media` - 2Tb unencrypted partition, storing media server and games, shared between OS.

> `/boot` partition is part of encrypted root, just storing temporary files for generating UKIs. UKI is then placed into EFI.

## Additional actions for UKI / encryption

This can be done during install (before all mkinitcpio hooks), but we are doing it at the end for now.

### Generate UKI

- edit /etc/mkinitcpio.conf, add sd-encrypt before filesystems hook
- edit /etc/mkinitcpio.d/linux.preset, comment `default_image`, uncomment `default_uki`
- add /etc/kernel/cmdline, otherwise it will use host system wrong params
  - `rd.luks.name=<UUID>=root root=/dev/mapper/root rw`
- mkdir -p /efi/EFI/Linux
- mkinitcpio -P

### Sign UKI

- pacman -S sbctl (include in packages in future)
- copy /var/lib/sbctl to installed system /var/lib/sbctl (in future symlink it from /mnt/data/security)
- sbctl sign /efi/EFI/Linux/arch-linux.efi

### If TPM chain fails - regenerate the key

- `cryptsetup luksKillSlot /dev/<device> 2 # the id of the key for TPM`
  - or `systemd-cryptenroll --wipe-slot=tpm2 /drive`
- `systemd-cryptenroll /dev/<device> --wipe-slot=empty --tpm2-device=auto --tpm2-pcrs=7+15 # --tpm2-with-pin=yes`

### Include other encrypted volumes

Add entries to /etc/crypttab (data is name of device):

```
data UUID=1234...1234 none luks
backup UUID=1234...12 none luks
```

### (optional) install systemd-boot

We can load UKI efi directly, but we can use systemd-boot for a better menu for multibooting between OSs:

```
bootctl install
# and then sign the bootloader
```

### After installing windows x2

Both windows are installed into the same bootloader. Clone it, point to both from systemd-boot entries, load to each Windows and edit BCD to only leave one entry.

## OS setup

### Linux Maintenance

#### During install actions

- Before install - copy /mnt/data data from some other linux so we have Dropbox/Security/etc files.
  - (copy this) SbCtl keys: /var/lib/sbctl -> /mnt/data/security/sbctl
  - Flatpak user folder: ~/.var/app (includes Zen settings): /mnt/data/home/.var

This doesn't work during hostinstall/livecd, so we need to do this manually rigth after booting into the system:

0. (to delete old entries): efibootmgr, efibootmgr -b 0000 -B (0000 id of it, -B deletes)
1. Re-install bootctl so it creates EFI record, from within installed and loaded system.
2. Re-enroll all drives to TPM2 (it asks for password after install).
3. Enable UFW - for now not automated (sudo ufw enable)

#### Setting up

- Sign in to Dropbox, link the device.
- Sign in to Telegram app.
  - No sound for notifications.
- If Zen cache backup is lost/missing and/or on Windows:
  - skip import, google
  - Make default browser
  - personal space popcorn icon + personal container
  - work space pc icon + work container
  - setup containers: personal, work, vpn
  - sign in, let extensions install
  - Surfingkeys, use GIST settings
  - Set up proxies for containers (if have any, when needed).
  - Pin (vpn-ed if needed) chatgpt/grok.
- Connect bluetooth: mouse, headphones.
- Install Surfingkeys to Firefox & load my config
- Sign in to Steam, set up in the same way as for Gaming windows (see below)

### Windows Maintenance / install

Rufus:
- Uncheck remove requirement for ram/secureboot/tpm2
- Check remove requirement for online account
- Check create local account: ewancoder
- Uncheck set regional options
- Check disable data collection
- Uncheck disable bitlocker
- Check use windows CA 2023
- To make sure PRO version is installed: add Sources/PID.txt file with this content:

```
[PID]
Value=VK7JG-NPHTM-C97JM-9MPGT-3V66T
```

Laptop quirks:
- Unfortunately Rufus-created ISO didn't work for laptop (missing secureboot keys for Windows bootmgr? cause Rufus bootloader has loaded, it just couldn't load the Windows one)
  - So we needed to turn off secure boot for initial install
  - Then go back to the settings and re-enable it
  - Then activate BitLocker manually

Install:
- Insert Ethernet cable (no WiFi for PC AND Laptop)
- Language: US, US
- Keyboard: Dvorak
- Install new, Don't have a key, 11Pro, US, Dvorak, Skip other layouts
- Do not show again and skip Gigabyte center
- Delete OneDrive
- Change PC name to odinwin/thorwin/etc, odinwingaming/odinwinwork
- Update everything, activate if needed (check activation)
- Delete US (qwerty) keyboard, add Russian input method (uncheck everything when adding)
- (optional) Select language for non-unicode programs - russian (needed for russian in console apps)
  - If this is done - disable notepad spellcheck, otherwise it highlights everything
- Enable RDP access
- Create second desktop (Fun and Work)
- Zen
  - look at Linux guide - repeat it
- Install G-Helper (download/run)
  - Ultimate mode (standard/optimized when needed)
  - Balanced fans (turbo when needed)
  - Red Highlight keyboard mode
  - Battery charge - 80% (TODO: consider doing this on Linux)
- If new drives
  - Install Magician, test them, make sure OP is on, set Performance mode
- Turn on Bitlocker (will bind to 0 2 4 11 unfortunately due to custom key, not to 7 11, but this is supposed to be also secure)
  - NDA drive - autounlock, no password - more secure than password (bound to TPM)
- Power Plan: monitor always on, sleep disabled, power button does nothing
  - For laptop close lid = sleep, for easier sleep when needed
- Timezone: Tbilisi
- Install Bluetooth & WiFi drivers from x870e Pro 1.1
  - On laptop just connect to wifi, drivers auto-installed
- Connect to wifi/bluetooth devices, disconnect ethernet
- Install qBitTorrent app - it also disabled Windows Path length limitation
- Sign in to Telegram
  - (work-pc/laptop) Start with Windows
  - Disable notification sound
- Bluetooth: connect mouse/headphones if needed
- LogiOptions software for the Vertical mouse (pair dongle if needed)
- NVidia App, game ready driver, do NOT optimize game, NO overlay, download and install driver, reboot
- Steam (except work-pc, unless I want some light games during work, then there too)
  - Invisible
  - In-game: F12 performance, F11 screenshot, don't display notification for screenshot, top right fps
  - Interface: do not notify news, startup location - library
  - Downloads: allow downloads during gameplay
  - Notifications: disable show toast when friend joins a game
  - Add library: m/Media, load all cloud saves, run couple games to install vcredist
- Run icons.reg, UTC.reg, regenerate time by Windows
- (work-pc) DEV
  - ln -s /n/work ~/work (NDA volume)
  - VS2026: asp.net + .net desktop, tools import/export reset all settings if needed
    - Sign in with GitHub, sign in with Microsoft account
    - Set C# 2005 (otherwise ctrl+w doesn't work)
    - VSVim, handle all by VS except Ctrl+W, delete window.closewindow ctrl+w shortcut
    - Extensions
      - NCrunch, half of cores (8), 16 background threads + fast lane, fastest, run all, 100Gb RDI on C:
      - Unobtrusive code, collapsed by default - false
      - SonarQube (connect if needed)
  - Git: low transparency, 14pt, 130x30, random background dark color
  - .NET 8, 9 SDKs
  - Teams, Zoom, Slack - log in
  - Sign in to Windows APP VDI (also do this on Gaming Win just for convenience)
  - Clone dotfiles to ~/dotfiles
    - move dotfiles/.git to ~/.git
    - remove the ~/dotfiles dir
    - do git reset --hard
    - rename ~/.git to ~/.dotfiles
    - restart bash
  - Edit .gitconfig-work, git update-index --assume-unchanged .gitconfig-work
  - Copy ~/.gnupg from linux (or import/export needed signing keys)
    - If copied - delete gpg-agent.conf, pinentry-tty doesn't work on windows
    - gpg --list-secret-keys --with-subkey-fingerprints
    - gpg --export-secret-subkey ID > key.gpg
    - base64 key.gpg ---> send to where it's needed, then base64 -d DATA > key.gpg
    - gpg --import key.gpg
    - gpg --editkey ID, trust 5 (ultimate)
- Disable keyboard shortcuts for sticky keys
- Taskbar left, search hide, all icons remove, task view off, widgets off, show icon where window is open, combine when taskbar is full on both monitors
- Install PIA, need VPN in Belarus / other country
- Tray icons - ALL, remove bluetooth icon by right-clicking
- Unpin Music, Videos, Pictures, Desktop, pin useful folders
  - For Work - projects/work
  - For Gaming - games/media
- Unpin all from start
- Install Spotify - login

### Software setup (consolidated)

- VS Code
  - Extensions: Vim, ShellCheck, Angular Language Service
- MegaSync
  - On encrypted partition
  - Sync `/cloud` folder as main folder for all cloud files
    - `/mnt/data/cloud` on linux
    - `(d/c)/cloud` on windows

### BYOD Windows

- OEM (Home) / or custom Pro license
- Online account, location/etc all on, everything else skip, keep setup mail app
- Name of device (myname) for now, rename later
- GHelper - performance/turbo for sure
- Join BYOD

### Security setup

Setup TPM+Pin on movable devices. For linux use --tpm-with-pin, for windows the following:

- gpedit.msc, Computer Configuration -> Administrative Templates -> Windows Components -> BitLocker Drive Encryption -> Operating System Drives
  - Require additional authentication at startup - enabled, require with PIN & TPM
  - Allow enhanced PINs for startup - enabled
- gpupdate /force (or reboot)
- manage-bde -protectors -add C: -TPMAndPIN
- manage-bde -protectors -get C:

> If multibooting windows - make sure the necessary BCD is in the /efi/Microsoft folder, move back after it as necessary.

> You can use FIDO (yubikey) for linux as an alternative to TPM+pin. In Windows you can use Fido for Windows Hello login (but only for online accounts).

#### Fido device (on linux)

systemd-cryptenroll --fido2-device=auto --fido2-with-client-pin=true --fido2-with-user-presence=true --fido2-with-user-verification=true
